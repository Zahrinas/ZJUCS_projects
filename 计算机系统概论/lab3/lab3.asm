.ORIG x3000
LD R1, OUTS
LOOP
TRAP x20
TRAP x21
LD R7, N_ENTER
ADD R7, R0, R7
BRZ RETURN
LD R7, N_LPUSH
ADD R7, R0, R7
BRZ SW_LPUSH
LD R7, N_LPOP
ADD R7, R0, R7
BRZ SW_LPOP
LD R7, N_RPUSH
ADD R7, R0, R7
BRZ SW_RPUSH
LD R7, N_RPOP
ADD R7, R0, R7
BRZ SW_RPOP

SW_LPUSH
LD R7, START
TRAP x20
TRAP x21
ADD R7, R7, #-1
STR R0, R7, #0
ST R7, START
BRNZP LOOP

SW_RPUSH
LD R7, END
TRAP x20
TRAP x21
STR R0, R7, #0
ADD R7, R7, #1
ST R7, END
BRNZP LOOP

SW_LPOP
LD R7, END
NOT R6, R7
ADD R6, R6, #1
LD R7, START
ADD R6, R6, R7
BRZ POP_FAIL
LDR R0, R7, #0
STR R0, R1, #0
ADD R1, R1, #1
ADD R7, R7, #1
ST R7, START
BRNZP LOOP

SW_RPOP
LD R7, START
NOT R6, R7
ADD R6, R6, #1
LD R7, END
ADD R6, R6, R7
BRZ POP_FAIL
ADD R7, R7, #-1
LDR R0, R7, #0
STR R0, R1, #0
ADD R1, R1, #1
ST R7, END
BRNZP LOOP

POP_FAIL
LD R0, CHARFAIL
STR R0, R1, #0
ADD R1, R1, #1
BRNZP LOOP

RETURN
AND R0, R0, #0
STR R0, R1, #0
LD R0, OUTS
TRAP x22
TRAP x25

START .FILL x3200
END .FILL x3200
OUTS .FILL x3400
N_ENTER .FILL xFFF6;000A
N_LPUSH .FILL xFFD5;002B
N_LPOP .FILL xFFD3;002D
N_RPUSH .FILL xFFA5;005B
N_RPOP .FILL xFFA3;005D
CHARFAIL .FILL x005F
.END