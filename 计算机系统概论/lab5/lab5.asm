.ORIG x3000
LD R6, ADDR_M
ADD R6, R6, #-1
LD R0, INF
STR R0, R6, #0

LDI R0, ADDR_M
ADD R0, R0, #-1
LOOPI_0
LDI R1, ADDR_N
ADD R1, R1, #-1
LOOPJ_0
AND R2, R2, #0
LDI R3, ADDR_N
AND R4, R4, #0
ADD R4, R4, R0
BRZ OUTLOOPMUL_0
LOOPMUL_0
ADD R2, R2, R3
ADD R4, R4, #-1
BRP LOOPMUL_0
OUTLOOPMUL_0
ADD R2, R2, R1
LD R3, VISIT
ADD R3, R2, R3
AND R4, R4, #0
STR R4, R3, #0
ADD R1, R1, #-1
BRZP LOOPJ_0
ADD R0, R0, #-1
BRZP LOOPI_0

AND R2, R2, #0
LDI R0, ADDR_M
ADD R0, R0, #-1
LOOPI
LDI R1, ADDR_N
ADD R1, R1, #-1
LOOPJ
JSR MSEAR
ADD R4, R5, #-1
NOT R4, R4
ADD R4, R4, #1
ADD R4, R2, R4
BRP NONUPDATE
ADD R2, R5, #-1
NONUPDATE
ADD R1, R1, #-1
BRZP LOOPJ
ADD R0, R0, #-1
BRZP LOOPI
TRAP x25

MSEAR
ADD R6, R6, #-6
STR R0, R6, #0
STR R1, R6, #1
STR R2, R6, #2
STR R3, R6, #3
STR R4, R6, #4
STR R7, R6, #5
ADD R0, R0, #0
BRN RETURN_FAIL
ADD R1, R1, #0
BRN RETURN_FAIL
LDI R2, ADDR_M
NOT R2, R2
ADD R2, R2, #1
ADD R2, R0, R2
BRZP RETURN_FAIL
LDI R2, ADDR_N
NOT R2, R2
ADD R2, R2, #1
ADD R2, R1, R2
BRZP RETURN_FAIL

AND R2, R2, #0
LDI R3, ADDR_N
AND R4, R4, #0
ADD R4, R4, R0
BRZ OUTLOOPMUL
LOOPMUL
ADD R2, R2, R3
ADD R4, R4, #-1
BRP LOOPMUL
OUTLOOPMUL
ADD R2, R2, R1
LD R3, ADDR_ARRAY
ADD R3, R2, R3
LDR R3, R3, #0
LDR R4, R6, #6
NOT R4, R4
ADD R4, R4, #1
ADD R4, R3, R4
BRZP RETURN_FAIL
LD R3, VISIT
ADD R3, R2, R3
LDR R4, R3, #0
ADD R4, R4, #0
BRP RETURN_VISITED
ADD R4, R4, #1
STR R4, R3, #0

ADD R6, R6, #-1
LD R3, ADDR_ARRAY
ADD R3, R2, R3
LDR R3, R3, #0
STR R3, R6, #0
LD R3, DP
ADD R3, R2, R3
AND R2, R2, #0
ADD R2, R2, #1
STR R2, R3, #0
ADD R0, R0, #1
JSR MSEAR
LDR R2, R3, #0
NOT R2, R2
ADD R2, R2, #1
ADD R4, R2, R5
BRNZ CHECK2
STR R5, R3, #0
CHECK2
ADD R0, R0, #-2
JSR MSEAR
LDR R2, R3, #0
NOT R2, R2
ADD R2, R2, #1
ADD R4, R2, R5
BRNZ CHECK3
STR R5, R3, #0
CHECK3
ADD R0, R0, #1
ADD R1, R1, #1
JSR MSEAR
LDR R2, R3, #0
NOT R2, R2
ADD R2, R2, #1
ADD R4, R2, R5
BRNZ CHECK4
STR R5, R3, #0
CHECK4
ADD R1, R1, #-2
JSR MSEAR
LDR R2, R3, #0
NOT R2, R2
ADD R2, R2, #1
ADD R4, R2, R5
BRNZ CHECKF
STR R5, R3, #0
CHECKF
ADD R1, R1, #1
ADD R6, R6, #1
LDR R5, R3, #0
ADD R5, R5, #1
LDR R0, R6, #0
LDR R1, R6, #1
LDR R2, R6, #2
LDR R3, R6, #3
LDR R4, R6, #4
LDR R7, R6, #5
ADD R6, R6, #6
RET

RETURN_FAIL
AND R5, R5, #0
ADD R5, R5, #1
LDR R0, R6, #0
LDR R1, R6, #1
LDR R2, R6, #2
LDR R3, R6, #3
LDR R4, R6, #4
LDR R7, R6, #5
ADD R6, R6, #6
RET

RETURN_VISITED
AND R2, R2, #0
LDI R3, ADDR_N
AND R4, R4, #0
ADD R4, R4, R0
BRZ OUTLOOPMULV
LOOPMULV
ADD R2, R2, R3
ADD R4, R4, #-1
BRP LOOPMULV
OUTLOOPMULV
ADD R2, R2, R1
LD R3, DP
ADD R3, R2, R3
LDR R5, R3, #0
ADD R5, R5, #1
LDR R0, R6, #0
LDR R1, R6, #1
LDR R2, R6, #2
LDR R3, R6, #3
LDR R4, R6, #4
LDR R7, R6, #5
ADD R6, R6, #6
RET

INF .FILL x7FFF
DP .FILL x3200
VISIT .FILL x3300
ADDR_M .FILL x4000
ADDR_N .FILL x4001
ADDR_ARRAY .FILL x4002
.END

.ORIG x4000
.FILL #3
.FILL #4
.FILL #89
.FILL #88
.FILL #86
.FILL #83
.FILL #79
.FILL #73
.FILL #90
.FILL #80
.FILL #60
.FILL #69
.FILL #73
.FILL #77
.END